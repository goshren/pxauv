/************************************************************************************
					文件名：MainCabin_MenuTest.c
					最后一次修改时间：2025/6/29
					修改内容：主控舱模块菜单测试程序
*************************************************************************************/

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include "MainCabin.h"

extern int g_maincabin_tcpclisock_fd;
extern volatile int g_maincabin_tcpcliConnectFlag;

// 显示菜单
void show_menu() {
    printf("\n========== 主控舱测试菜单 ==========\n");
    printf("1. 初始化主控舱模块\n");
    printf("2. 单个设备电源控制\n");
    printf("3. 批量供电(除释放器外)\n");
    printf("4. 批量断电(除释放器外)\n");
    printf("5. 读取并显示传感器数据\n");
    printf("6. 显示当前状态\n");
    printf("0. 退出\n");
    printf("===================================\n");
    printf("请选择操作: ");
}

// 单个设备电源控制子菜单
void device_power_menu() {
    int choice, power;
    printf("\n--- 单个设备电源控制 ---\n");
    printf("1. CTD\n");
    printf("2. DVL\n");
    printf("3. USBL\n");
    printf("4. 数传电台\n");
    printf("5. 声呐\n");
    printf("6. 释放器1\n");
    printf("7. 释放器2\n");
    printf("0. 返回主菜单\n");
    printf("选择设备: ");
    scanf("%d", &choice);
    
    if(choice == 0) return;
    
    printf("操作: 1-供电, -1-断电: ");
    scanf("%d", &power);
    
    if(choice >= 1 && choice <= 7 && (power == 1 || power == -1)) {
        if(MainCabin_SwitchPowerDevice(choice-1, power) < 0) {
            printf("操作失败!\n");
        } else {
            printf("操作成功!\n");
        }
    } else {
        printf("无效输入!\n");
    }
}

// 读取并显示传感器数据
void read_and_display_data() {
    printf("\n正在读取传感器数据...\n");
    if(MainCabin_ReadRawData() < 0) {
        printf("错误：读取原始数据失败！\n");
        return;
    }
    
    if(MainCabin_ParseData() < 0) {
        printf("错误：数据解析失败！\n");
        return;
    }
    
    MainCabin_PrintSensorData();
    
    char *packedData = MainCabin_DataPackageProcessing();
    printf("打包后的数据: %s\n", packedData);
}

// 显示当前状态
void show_status() {
    printf("\n--- 当前状态 ---\n");
    printf("TCP连接状态: %s\n", g_maincabin_tcpcliConnectFlag == 1 ? "已连接" : "未连接");
    printf("TCP文件描述符: %d\n", g_maincabin_tcpclisock_fd);
    printf("----------------\n");
}

int main(int argc, char *argv[]) {
    int choice;
    
    printf("主控舱模块菜单测试程序\n");
    
    while(1) {
        show_menu();
        scanf("%d", &choice);
        
        switch(choice) {
            case 0:
                printf("退出程序...\n");
                exit(0);
                
            case 1:
                printf("\n正在初始化主控舱模块...\n");
                if(MainCabin_Init() < 0) {
                    printf("错误：主控舱初始化失败！\n");
                } else {
                    printf("主控舱模块初始化成功\n");
                }
                break;
                
            case 2:
                device_power_menu();
                break;
                
            case 3:
                printf("\n正在给所有设备(除释放器)供电...\n");
                if(MainCabin_PowerOnAllDeviceExceptReleaser() < 0) {
                    printf("批量供电失败\n");
                } else {
                    printf("批量供电成功\n");
                }
                break;
                
            case 4:
                printf("\n正在给所有设备(除释放器)断电...\n");
                if(MainCabin_PowerOffAllDeviceExceptReleaser() < 0) {
                    printf("批量断电失败\n");
                } else {
                    printf("批量断电成功\n");
                }
                break;
                
            case 5:
                read_and_display_data();
                break;
                
            case 6:
                show_status();
                break;
                
            default:
                printf("无效选择，请重新输入!\n");
        }
        
        // 防止快速切换菜单时显示混乱
        sleep(1);
    }
    
    return 0;
}