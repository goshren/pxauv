/************************************************************************************
                    文件名：RangeSonar_MenuTest.c
                    最后一次修改时间：2025/6/29
                    修改内容：测距声呐模块菜单测试程序
*************************************************************************************/

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include "RangeSonar.h"

extern int g_rangeSonar_tcpclisock_fd;
extern volatile int g_rangeSonar_tcpcliConnectFlag;

// 显示主菜单
void show_main_menu() {
    printf("\n========== 测距声呐测试菜单 ==========\n");
    printf("1. 初始化测距声呐模块\n");
    printf("2. 发送初始化配置\n");
    printf("3. 读取并解析数据100次\n");
    printf("4. 获取障碍物距离\n");
    printf("5. 显示当前状态\n");
    printf("6. 断开连接\n");
    printf("0. 退出\n");
    printf("====================================\n");
    printf("请选择操作: ");
}

// 显示当前状态
void show_current_status() {
    printf("\n--- 当前状态 ---\n");
    printf("TCP连接状态: %s\n", g_rangeSonar_tcpcliConnectFlag == 1 ? "已连接" : "未连接");
    printf("TCP文件描述符: %d\n", g_rangeSonar_tcpclisock_fd);
    printf("最后测量距离: %d cm\n", RangeSonar_getDistanceFirstObstacleValue());
    printf("----------------\n");
}

int main()
{
    int ret = -1;
    pthread_t tid;
    
    RangeSonar_StartWorkerThread();
    while(1);
}


int main1(int argc, char *argv[]) {
    int choice;
    int distance;
    
    printf("测距声呐模块菜单测试程序\n");
    
    while(1) {
        show_main_menu();
        scanf("%d", &choice);
        
        switch(choice) {
            case 0:
                printf("退出程序...\n");
                // 确保断开连接
                if(g_rangeSonar_tcpcliConnectFlag == 1) {
                    RangeSonar_Deinit();
                }
                exit(0);
                
            case 1:
                printf("\n正在初始化测距声呐模块...\n");
                if(RangeSonar_Init() < 0) {
                    printf("错误：测距声呐初始化失败！\n");
                } else {
                    printf("测距声呐模块初始化成功\n");
                }
                break;
                
            case 2:
                printf("\n正在发送初始化配置...\n");
                if(RangeSonar_SendInitConfig() < 0) {
                    printf("错误：发送初始化配置失败！\n");
                } else {
                    printf("初始化配置发送成功\n");
                }
                break;
                
            case 3:
                printf("\n正在读取并解析数据...\n");
                for(int i = 0; i < 100; i++)
                {
                    sleep(1);

                    if(RangeSonar_ReadRawData() < 0) {
                        printf("错误：读取原始数据失败！\n");
                        break;
                    }

                    if(RangeSonar_ParseData() < 0) {
                        printf("错误：数据解析失败！\n");
                        break;
                    }

                    RangeSonar_PrintSonarData();
                    printf("\n\n");
                }

                break;
                
            case 4:
                distance = RangeSonar_getDistanceFirstObstacleValue();
                printf("\n第一个障碍物距离: %d cm\n", distance);
                break;
                
            case 5:
                show_current_status();
                break;
                
            case 6:
                printf("\n正在断开连接...\n");
                RangeSonar_Deinit();
                printf("已断开连接\n");
                break;
                
            default:
                printf("无效选择，请重新输入!\n");
        }
        
        // 防止快速切换菜单时显示混乱
        sleep(1);
    }
    
    return 0;
}